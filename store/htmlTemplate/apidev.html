<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API 参数调试器</title>
  <style>
    /* CSS 样式：保持紧凑并易读 */
    body {
      font-family: sans-serif;
      margin: 5px;
      background-color: #f7f7f7;
      color: #333;
    }

    .container {
      max-width: 100%;
      margin: auto;
      background: #fff;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* 顶部控制栏 */
    .controls {
      display: flex;
      align-items: center;
      gap: 5px;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
      margin-bottom: 8px;
    }

    .controls input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .controls button {
      padding: 5px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      background-color: #f0f0f0;
      font-size: 13px;
      line-height: 1.2;
    }

    .controls button:hover {
      background-color: #e0e0e0;
    }

    .btn-add {
      font-size: 16px;
    }

    .btn-merge {
      font-weight: bold;
    }

    /* 参数列表行 */
    #param-list .param-row {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 8px;
    }

    #param-list .param-row:last-child {
      margin-bottom: 0;
    }

    #param-list .param-row input[type="checkbox"] {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    #param-list .param-row input[type="text"] {
      flex-grow: 1;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: ui-monospace, Consolas, Menlo, Monaco, monospace;
      font-size: 13px;
    }

    #param-list .param-row button {
      padding: 4px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      background-color: #fafafa;
      font-size: 12px;
    }

    /* API 端点面板 */
    .api-panel {
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
      margin-bottom: 8px;
    }

    #api-buttons-container button {
      margin: 0 5px 5px 0;
      padding: 5px 10px;
      border: 1px solid #90caf9;
      background-color: #e3f2fd;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }

    #api-buttons-container button:hover {
      background-color: #bbdefb;
    }

    /* 【修改点 1】为 API 请求方法(method)添加的样式 */
    .api-method {
      font-size: 0.8em;
      /* 字体更小 */
      color: #888;
      /* 颜色更灰 */
      margin-right: 4px;
    }
  </style>
</head>

<body>

  <div class="container">
    <div id="api-endpoints" class="api-panel">
      {{api-buttons-container}}
    </div>

    <div class="controls">
      <input type="checkbox" id="select-all" title="智能选择/取消">
      <button class="btn-add" onclick="addParamRow()" title="添加新行">➕</button>
      <button class="btn-merge" onclick="console.log(getMergedParams())">控制台输出融合参数</button>
      <button class="btn-batch-delete" onclick="batchDelete()">批量删除选中</button>
    </div>
    <div id="param-list">
    </div>
  </div>

  <script>
    const paramList = document.getElementById("param-list");
    const selectAllCheckbox = document.getElementById("select-all");
    const STORAGE_KEY = "apidev-" + location.host;

    // ---- 核心逻辑 ----
    /** 除了考虑get的键值形式,还要兼容post,允许json数组和raw */
    function 参数化(str) {
      // 重写,首先看是否能json
      let obj = {}
      try {
        return JSON.parse(str)
      } catch (e) { }
      // 那应该是键值字符串或纯字符串
      if (str.includes("=")) {
        new URLSearchParams(str).forEach((v, k) => { obj[k] = v; })
        return obj
      }
      return str;
    }
    // 关键在此,如何处理参数
    function getMergedParams() {
      let res;
      document.querySelectorAll(".param-row input[type=checkbox]:checked").forEach(checkbox => {
        const row = checkbox.closest(".param-row");
        const input = row.querySelector("input[type=text]");
        const param = 参数化(input.value);
        // 现在考虑如何融合obj arr str; 选定第一个类型后,只做同类型融
        if (typeof res === "object") {
          if (Array.isArray(res)) {
            if (Array.isArray(param)) res = [...res, ...param]
          } else {
            if (typeof param === "object" && !Array.isArray(param)) res = { ...res, ...param }
          }
        } else if (typeof res === "string") {
          if (typeof param === "string") res += param
        }
        else if (typeof res === "undefined") {
          res = param
        }
      });
      return res;
    }
    /** 默认method为POST */
    async function sendRequest(url, method = "POST") {
      const params = getMergedParams();
      method = method === '*' ? 'POST' : method.toUpperCase();
      // 【修改点 3】将 "color: blue" 改为更亮的 "color: dodgerblue"
      console.log(`%c[Requesting]%c ${method} ${url}`, "color: dodgerblue; font-weight: bold;", "color: white;");
      console.log("%c[Parameters]", "color: dodgerblue; font-weight: bold;", params);
      const options = {
        method: method,
        headers: { "Content-Type": "application/json" }
      };
      let finalUrl = url;
      if (["GET", "HEAD"].includes(method)) {
        const queryString = new URLSearchParams(params).toString();
        if (queryString) {
          finalUrl += (finalUrl.includes("?") ? "&" : "?") + queryString;
        }
      } else {
        options.body = JSON.stringify(params);
      }
      try {
        const response = await fetch(finalUrl, options);
        console.log(`%c[Response] %cStatus: ${response.status} ${response.statusText}`, "color: green; font-weight: bold;", `color: ${response.ok ? "green" : "red"};`);
        const contentType = response.headers.get("content-type");
        if (contentType && contentType.indexOf("application/json") !== -1) {
          const data = await response.json();
          console.log("%c[Data]", "color: green; font-weight: bold;", data);
        } else {
          const text = await response.text();
          console.log("%c[Data]", "color: green; font-weight: bold;", text);
        }
      } catch (error) {
        console.error(`%c[DataError]`, "color: red; font-weight: bold;", error);
      }
    }

    // ---- 页面交互与DOM操作 ----
    document.addEventListener("DOMContentLoaded", loadState);
    selectAllCheckbox.addEventListener("click", toggleSelectAll);
    function createParamRow(value = "", isChecked = false) {
      const row = document.createElement("div");
      row.className = "param-row";
      row.innerHTML = `
            <input type="checkbox" ${isChecked ? "checked" : ""}>
            <input type="text" value="">
            <button title="克隆此行">克隆</button>
            <button title="删除此行">删除</button>
        `;
      row.querySelector("input[type=text]").value = value;

      const checkbox = row.querySelector("input[type=checkbox]");
      const textInput = row.querySelector("input[type=text]");

      checkbox.addEventListener("change", () => {
        updateSelectAllCheckboxState();
        saveState();
      });
      textInput.addEventListener("input", saveState);

      // 【新增逻辑】为文本框添加回车键监听
      textInput.addEventListener("keydown", (event) => {
        if (event.key === 'Enter') {
          event.preventDefault(); // 阻止默认的回车行为 (如表单提交)
          checkbox.checked = !checkbox.checked; // 切换复选框的选中状态
          // 手动触发 change 事件, 以确保 saveState 和 updateSelectAllCheckboxState 被调用
          checkbox.dispatchEvent(new Event('change'));
        }
      });

      row.querySelector("button:nth-of-type(1)").addEventListener("click", () => cloneRow(row));
      row.querySelector("button:nth-of-type(2)").addEventListener("click", () => {
        row.remove();
        saveState();
      });
      return row;
    }


    function addParamRow() {
      paramList.appendChild(createParamRow("", true));
      saveState();
    }

    function cloneRow(rowToClone) {
      const value = rowToClone.querySelector("input[type=text]").value;
      const isChecked = rowToClone.querySelector("input[type=checkbox]").checked;
      const newRow = createParamRow(value, isChecked);
      rowToClone.after(newRow);
      saveState();
    }

    function batchDelete() {
      const rowsToDelete = document.querySelectorAll(".param-row input[type=checkbox]:checked");
      if (rowsToDelete.length > 0) {
        rowsToDelete.forEach(checkbox => checkbox.closest(".param-row").remove());
        saveState();
      }
    }

    function toggleSelectAll() {
      const checkedCount = document.querySelectorAll('.param-row input[type="checkbox"]:checked').length;
      const shouldCheckAll = checkedCount <= 1;
      document.querySelectorAll('.param-row input[type="checkbox"]').forEach(cb => cb.checked = shouldCheckAll);
      saveState();
    }

    function updateSelectAllCheckboxState() {
      const allCheckboxes = document.querySelectorAll(".param-row input[type=checkbox]");
      const checkedCount = document.querySelectorAll(".param-row input[type=checkbox]:checked").length;
      const totalCount = allCheckboxes.length;

      if (totalCount > 0 && checkedCount === totalCount) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
      } else if (checkedCount > 1) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
      } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      }
    }

    // ---- 数据持久化 (无变化) ----

    function saveState() {
      const data = [];
      document.querySelectorAll(".param-row").forEach(row => {
        data.push({
          value: row.querySelector("input[type=text]").value,
          isChecked: row.querySelector("input[type=checkbox]").checked
        });
      });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      updateSelectAllCheckboxState();
    }

    function loadState() {
      const savedData = localStorage.getItem(STORAGE_KEY);
      if (savedData) {
        const data = JSON.parse(savedData);
        if (data.length > 0) {
          data.forEach(item => {
            paramList.appendChild(createParamRow(item.value, item.isChecked));
          });
        }
      } else {
        paramList.appendChild(createParamRow("hi=Ghini&hello=world", true));
        paramList.appendChild(createParamRow("hello world", false));
        paramList.appendChild(createParamRow('{"example": true, "test":     {"number": [1,["b"],{"fruit":"peach"}]}}', true));
        paramList.appendChild(createParamRow(`[1,"2","three"]`, true));
      }
      updateSelectAllCheckboxState();
    }
  </script>

</body>

</html>
