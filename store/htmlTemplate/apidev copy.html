<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API 参数调试器</title>
  <style>
    /* CSS 样式：保持紧凑并易读 */
    body {
      font-family: sans-serif;
      margin: 5px;
      background-color: #f7f7f7;
      color: #333;
    }

    .container {
      max-width: 100%;
      margin: auto;
      background: #fff;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* 顶部控制栏 */
    .controls {
      display: flex;
      align-items: center;
      gap: 5px;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
      margin-bottom: 8px;
    }

    .controls input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .controls button {
      padding: 5px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      background-color: #f0f0f0;
      font-size: 13px;
      line-height: 1.2;
    }

    .controls button:hover {
      background-color: #e0e0e0;
    }

    .btn-add {
      font-size: 16px;
    }

    .btn-merge {
      font-weight: bold;
    }

    .btn-init {
      background-color: #fff3e0;
      border-color: #ffb74d;
      color: #e65100;
    }

    .btn-init:hover {
      background-color: #ffe0b2;
    }

    /* 参数列表行 */
    #param-list .param-row {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 8px;
      cursor: grab;
      transition: transform 0.2s;
    }

    #param-list .param-row:active {
      cursor: grabbing;
    }

    #param-list .param-row.dragging {
      opacity: 0.5;
      transform: scale(0.98);
      cursor: grabbing;
    }

    #param-list .param-row.drag-over-top {
      box-shadow: 0 -2px 0 0 #4CAF50;
    }

    #param-list .param-row.drag-over-bottom {
      box-shadow: 0 2px 0 0 #4CAF50;
    }

    #param-list .param-row:last-child {
      margin-bottom: 0;
    }

    #param-list .param-row input[type="checkbox"] {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    #param-list .param-row input[type="text"] {
      flex-grow: 1;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: ui-monospace, Consolas, Menlo, Monaco, monospace;
      font-size: 13px;
      cursor: text;
    }

    /* 紧凑按钮样式 */
    #param-list .param-row .btn-group {
      display: flex;
      gap: 2px;
    }

    #param-list .param-row button {
      padding: 4px 6px;
      border: 1px solid #ccc;
      border-radius: 3px;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
    }

    #param-list .param-row .btn-clone {
      background-color: #e3f2fd;
      border-color: #90caf9;
      color: #1976d2;
    }

    #param-list .param-row .btn-clone:hover {
      background-color: #bbdefb;
    }

    #param-list .param-row .btn-delete {
      background-color: #ffebee;
      border-color: #ef9a9a;
      color: #c62828;
    }

    #param-list .param-row .btn-delete:hover {
      background-color: #ffcdd2;
    }

    #param-list .param-row .btn-split {
      background-color: #f5f5f5;
      border-color: #bdbdbd;
    }

    #param-list .param-row .btn-split:hover {
      background-color: #e0e0e0;
    }

    /* 分隔线样式 */
    .separator-row {
      display: flex;
      align-items: center;
      margin: 4px 0;
      height: 20px;
      position: relative;
      cursor: grab;
    }

    .separator-row:active {
      cursor: grabbing;
    }

    .separator-row::before {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      top: 50%;
      height: 2px;
      background-color: #e0e0e0;
      transform: translateY(-50%);
    }

    .separator-row.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }

    .separator-row.drag-over-top {
      box-shadow: 0 -2px 0 0 #4CAF50;
    }

    .separator-row.drag-over-bottom {
      box-shadow: 0 2px 0 0 #4CAF50;
    }

    .separator-label {
      background: #fff;
      padding: 0 10px;
      position: relative;
      z-index: 1;
      margin-left: 10px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .separator-label span {
      color: #333;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .separator-label input {
      border: 1px solid #ddd;
      padding: 3px 6px;
      font-size: 14px;
      font-weight: 600;
      border-radius: 3px;
    }

    .separator-label button {
      padding: 2px 6px;
      border: 1px solid #ccc;
      border-radius: 3px;
      cursor: pointer;
      font-size: 10px;
      background-color: #f5f5f5;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .separator-label button:hover {
      background-color: #e0e0e0;
      opacity: 1;
    }

    /* API 端点面板 */
    .api-panel {
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
      margin-bottom: 8px;
    }

    #api-buttons-container button {
      margin: 0 5px 5px 0;
      padding: 5px 10px;
      border: 1px solid #90caf9;
      background-color: #e3f2fd;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }

    #api-buttons-container button:hover {
      background-color: #bbdefb;
    }

    .api-method {
      font-size: 0.8em;
      color: #888;
      margin-right: 4px;
    }
  </style>
</head>

<body>

  <div class="container">
    <div id="api-endpoints" class="api-panel">
      {{api-buttons-container}}
    </div>

    <div class="controls">
      <input type="checkbox" id="select-all" title="智能选择/取消">
      <button class="btn-add" onclick="addParamRow()" title="添加新行">➕</button>
      <button class="btn-merge" onclick="console.log(getMergedParams())">控制台输出融合参数</button>
      <button class="btn-batch-delete" onclick="batchDelete()">批量删除选中</button>
      <button class="btn-init" onclick="initializeExample()">初始化参数</button>
    </div>
    <div id="param-list">
    </div>
  </div>

  <script>
    const paramList = document.getElementById("param-list");
    const selectAllCheckbox = document.getElementById("select-all");
    const STORAGE_KEY = "apidev-" + location.host;

    // ---- 拖拽功能 ----
    let draggedElement = null;

    function initDragAndDrop(element) {
      // 设置元素可拖拽，但会在特定情况下阻止
      element.draggable = true;
      
      // 阻止从特定元素开始的拖拽
      const noDragSelectors = 'input, button, .separator-label input, .separator-label button';
      element.querySelectorAll(noDragSelectors).forEach(el => {
        el.addEventListener('dragstart', (e) => {
          e.preventDefault();
          e.stopPropagation();
        });
      });
      
      element.addEventListener('dragstart', (e) => {
        // 检查拖拽是否从禁止的元素开始
        if (e.target.tagName === 'INPUT' || 
            e.target.tagName === 'BUTTON' ||
            e.target.closest('input') || 
            e.target.closest('button')) {
          e.preventDefault();
          return;
        }
        
        // 只有当从元素本身（非input/button）开始拖拽时才允许
        if (e.target === element || 
            (!e.target.matches(noDragSelectors) && e.target.closest('.param-row') === element) ||
            (!e.target.matches(noDragSelectors) && e.target.closest('.separator-row') === element)) {
          draggedElement = element;
          element.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
        } else {
          e.preventDefault();
        }
      });

      element.addEventListener('dragend', (e) => {
        element.classList.remove('dragging');
        draggedElement = null;
        saveState();
      });

      element.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        
        if (draggedElement && draggedElement !== element) {
          const rect = element.getBoundingClientRect();
          const midpoint = rect.top + rect.height / 2;
          
          // 清除所有拖拽指示
          element.classList.remove('drag-over-top', 'drag-over-bottom');
          
          // 根据鼠标位置显示上边框或下边框
          if (e.clientY < midpoint) {
            element.classList.add('drag-over-top');
          } else {
            element.classList.add('drag-over-bottom');
          }
        }
      });

      element.addEventListener('dragleave', (e) => {
        element.classList.remove('drag-over-top', 'drag-over-bottom');
      });

      element.addEventListener('drop', (e) => {
        e.preventDefault();
        element.classList.remove('drag-over-top', 'drag-over-bottom');
        
        if (draggedElement && draggedElement !== element) {
          const rect = element.getBoundingClientRect();
          const midpoint = rect.top + rect.height / 2;
          
          if (e.clientY < midpoint) {
            // 插入到目标元素之前
            element.parentNode.insertBefore(draggedElement, element);
          } else {
            // 插入到目标元素之后
            element.parentNode.insertBefore(draggedElement, element.nextSibling);
          }
        }
      });
    }

    // ---- 核心逻辑 ----
    function 参数化(str) {
      let obj = {}
      try {
        return JSON.parse(str)
      } catch (e) { }
      if (str.includes("=")) {
        new URLSearchParams(str).forEach((v, k) => { obj[k] = v; })
        return obj
      }
      return str;
    }

    function getMergedParams() {
      let res;
      document.querySelectorAll(".param-row input[type=checkbox]:checked").forEach(checkbox => {
        const row = checkbox.closest(".param-row");
        const input = row.querySelector("input[type=text]");
        const param = 参数化(input.value);
        if (typeof res === "object") {
          if (Array.isArray(res)) {
            if (Array.isArray(param)) res = [...res, ...param]
          } else {
            if (typeof param === "object" && !Array.isArray(param)) res = { ...res, ...param }
          }
        } else if (typeof res === "string") {
          if (typeof param === "string") res += param
        }
        else if (typeof res === "undefined") {
          res = param
        }
      });
      return res;
    }

    async function sendRequest(url, method = "POST") {
      const params = getMergedParams();
      method = method === '*' ? 'POST' : method.toUpperCase();
      console.log(`%c[Requesting]%c ${method} ${url}`, "color: dodgerblue; font-weight: bold;", "color: white;");
      console.log("%c[Parameters]", "color: dodgerblue; font-weight: bold;", params);
      const options = {
        method: method,
        headers: { "Content-Type": "application/json" }
      };
      let finalUrl = url;
      if (["GET", "HEAD"].includes(method)) {
        const queryString = new URLSearchParams(params).toString();
        if (queryString) {
          finalUrl += (finalUrl.includes("?") ? "&" : "?") + queryString;
        }
      } else {
        options.body = JSON.stringify(params);
      }
      try {
        const response = await fetch(finalUrl, options);
        console.log(`%c[Response] %cStatus: ${response.status} ${response.statusText}`, "color: green; font-weight: bold;", `color: ${response.ok ? "green" : "red"};`);
        const contentType = response.headers.get("content-type");
        if (contentType && contentType.indexOf("application/json") !== -1) {
          const data = await response.json();
          console.log("%c[Data]", "color: green; font-weight: bold;", data);
        } else {
          const text = await response.text();
          console.log("%c[Data]", "color: green; font-weight: bold;", text);
        }
      } catch (error) {
        console.error(`%c[DataError]`, "color: red; font-weight: bold;", error);
      }
    }

    // ---- 分隔线功能 ----
    function createSeparator(label = "分隔线") {
      const separator = document.createElement("div");
      separator.className = "separator-row";
      separator.draggable = true;
      
      const labelContainer = document.createElement("div");
      labelContainer.className = "separator-label";
      
      const labelText = document.createElement("span");
      labelText.textContent = label;
      
      const editBtn = document.createElement("button");
      editBtn.textContent = "修改";
      editBtn.draggable = false;
      
      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "删除";
      deleteBtn.style.marginLeft = "5px";
      deleteBtn.style.color = "#c62828";
      deleteBtn.draggable = false;
      
      labelContainer.appendChild(labelText);
      labelContainer.appendChild(editBtn);
      labelContainer.appendChild(deleteBtn);
      separator.appendChild(labelContainer);
      
      editBtn.addEventListener("click", () => {
        const input = document.createElement("input");
        input.type = "text";
        input.value = labelText.textContent;
        input.draggable = false;
        
        const confirmBtn = document.createElement("button");
        confirmBtn.textContent = "确认";
        confirmBtn.draggable = false;
        
        labelContainer.innerHTML = "";
        labelContainer.appendChild(input);
        labelContainer.appendChild(confirmBtn);
        
        input.focus();
        input.select();
        
        const confirm = () => {
          labelText.textContent = input.value || "分隔线";
          labelContainer.innerHTML = "";
          labelContainer.appendChild(labelText);
          labelContainer.appendChild(editBtn);
          labelContainer.appendChild(deleteBtn);
          saveState();
        };
        
        confirmBtn.addEventListener("click", confirm);
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") confirm();
        });
      });
      
      deleteBtn.addEventListener("click", () => {
        separator.remove();
        saveState();
      });
      
      initDragAndDrop(separator);
      
      return separator;
    }

    // ---- 页面交互与DOM操作 ----
    document.addEventListener("DOMContentLoaded", loadState);
    selectAllCheckbox.addEventListener("click", toggleSelectAll);

    function createParamRow(value = "", isChecked = false) {
      const row = document.createElement("div");
      row.className = "param-row";
      row.innerHTML = `
            <input type="checkbox" ${isChecked ? "checked" : ""}>
            <input type="text" value="">
            <div class="btn-group">
                <button class="btn-clone">克隆</button>
                <button class="btn-delete">删除</button>
                <button class="btn-split">分隔</button>
                <span>≡</span>
            </div>
        `;
      row.querySelector("input[type=text]").value = value;

      const checkbox = row.querySelector("input[type=checkbox]");
      const textInput = row.querySelector("input[type=text]");

      checkbox.addEventListener("change", () => {
        updateSelectAllCheckboxState();
        saveState();
      });
      textInput.addEventListener("input", saveState);

      textInput.addEventListener("keydown", (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          checkbox.checked = !checkbox.checked;
          checkbox.dispatchEvent(new Event('change'));
        }
      });

      // 动态控制draggable：当鼠标进入/聚焦input时禁用row的draggable，离开/失焦时恢复
      textInput.addEventListener('mouseenter', () => {
        row.draggable = false;
      });
      textInput.addEventListener('mouseleave', () => {
        row.draggable = true;
      });
      textInput.addEventListener('focus', () => {
        row.draggable = false;
      });
      textInput.addEventListener('blur', () => {
        row.draggable = true;
      });

      row.querySelector(".btn-clone").addEventListener("click", () => cloneRow(row));
      row.querySelector(".btn-delete").addEventListener("click", () => {
        row.remove();
        saveState();
      });
      
      // 分隔按钮功能
      row.querySelector(".btn-split").addEventListener("click", () => {
        const separator = createSeparator();
        row.parentNode.insertBefore(separator, row);
        saveState();
      });
      
      // 初始化拖拽
      initDragAndDrop(row);
      
      return row;
    }

    function addParamRow() {
      paramList.appendChild(createParamRow("", true));
      saveState();
    }

    function cloneRow(rowToClone) {
      const value = rowToClone.querySelector("input[type=text]").value;
      const isChecked = rowToClone.querySelector("input[type=checkbox]").checked;
      const newRow = createParamRow(value, isChecked);
      rowToClone.after(newRow);
      saveState();
    }

    function batchDelete() {
      const rowsToDelete = document.querySelectorAll(".param-row input[type=checkbox]:checked");
      if (rowsToDelete.length > 0) {
        rowsToDelete.forEach(checkbox => checkbox.closest(".param-row").remove());
        saveState();
      }
    }

    function toggleSelectAll() {
      const checkedCount = document.querySelectorAll('.param-row input[type="checkbox"]:checked').length;
      const shouldCheckAll = checkedCount <= 1;
      document.querySelectorAll('.param-row input[type="checkbox"]').forEach(cb => cb.checked = shouldCheckAll);
      saveState();
    }

    function updateSelectAllCheckboxState() {
      const allCheckboxes = document.querySelectorAll(".param-row input[type=checkbox]");
      const checkedCount = document.querySelectorAll(".param-row input[type=checkbox]:checked").length;
      const totalCount = allCheckboxes.length;

      if (totalCount > 0 && checkedCount === totalCount) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
      } else if (checkedCount > 1) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
      } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      }
    }

    // ---- 数据持久化 ----
    function saveState() {
      const data = [];
      // 使用 children 而不是 childNodes，避免文本节点
      Array.from(paramList.children).forEach(node => {
        if (node.classList && node.classList.contains("param-row")) {
          data.push({
            type: "param",
            value: node.querySelector("input[type=text]").value,
            isChecked: node.querySelector("input[type=checkbox]").checked
          });
        } else if (node.classList && node.classList.contains("separator-row")) {
          const labelText = node.querySelector(".separator-label span");
          data.push({
            type: "separator",
            label: labelText ? labelText.textContent : "分隔线"
          });
        }
      });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      updateSelectAllCheckboxState();
    }

    function initializeExample() {
      if (confirm("确定要初始化为示例参数吗？当前数据将被清空。")) {
        // 清空当前列表
        paramList.innerHTML = "";
        
        // 添加示例数据
        paramList.appendChild(createParamRow("hi=Ghini&hello=world", true));
        paramList.appendChild(createParamRow("hello world", false));
        paramList.appendChild(createParamRow('{"example": true, "test":     {"number": [1,["b"],{"fruit":"peach"}]}}', true));
        paramList.appendChild(createParamRow(`[1,"2","three"]`, true));
        paramList.appendChild(createSeparator("其他参数"));
        
        // 保存状态
        saveState();
        updateSelectAllCheckboxState();
      }
    }

    function loadState() {
      const savedData = localStorage.getItem(STORAGE_KEY);
      if (savedData) {
        const data = JSON.parse(savedData);
        if (data.length > 0) {
          data.forEach(item => {
            if (item.type === "separator") {
              paramList.appendChild(createSeparator(item.label));
            } else {
              paramList.appendChild(createParamRow(item.value || "", item.isChecked));
            }
          });
        }
      } else {
        paramList.appendChild(createParamRow("hi=Ghini&hello=world", true));
        paramList.appendChild(createParamRow("hello world", false));
        paramList.appendChild(createParamRow('{"example": true, "test":     {"number": [1,["b"],{"fruit":"peach"}]}}', true));
        paramList.appendChild(createParamRow(`[1,"2","three"]`, true));
        paramList.appendChild(createSeparator("其他参数"));
      }
      updateSelectAllCheckboxState();
    }
  </script>

</body>

</html>
